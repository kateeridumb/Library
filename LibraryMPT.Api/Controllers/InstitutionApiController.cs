using LibraryMPT.Data;using LibraryMPT.Api.Extensions;using LibraryMPT.Models;using Microsoft.AspNetCore.Authorization;using Microsoft.AspNetCore.Mvc;using Npgsql;using Microsoft.EntityFrameworkCore;namespace LibraryMPT.Api.Controllers;[ApiController][Authorize(Roles = "InstitutionRepresentative")][Route("api/institution")]public sealed class InstitutionApiController : ControllerBase{    private readonly LibraryContext _context;    private readonly ILogger<InstitutionApiController> _logger;    public InstitutionApiController(LibraryContext context, ILogger<InstitutionApiController> logger)    {        _context = context;        _logger = logger;    }    [HttpGet("index")]    public async Task<ActionResult<InstitutionIndexResponse>> Index()    {        var userId = User.GetUserId();        var facultyId = await _context.Database            .SqlQuery<int?>($"""                SELECT FacultyID AS "Value"                FROM Users                WHERE UserID = {userId}            """)            .SingleAsync();        if (!facultyId.HasValue)        {            return Ok(new InstitutionIndexResponse            {                HasFaculty = false,                ErrorMessage = "У вас не назначено учебное заведение"            });        }        var faculty = await _context.Faculty            .FromSqlRaw("SELECT facultyid AS \"FacultyID\", facultyname AS \"FacultyName\" FROM faculty WHERE facultyid = @id", new NpgsqlParameter("@id", facultyId.Value))            .AsNoTracking()            .FirstOrDefaultAsync();        Subscription? activeSubscription;        try        {            activeSubscription = await _context.Subscriptions                .FromSqlRaw("""                    SELECT                        SubscriptionID, FacultyID, Name, StartDate, EndDate, DurationDays, Status, RequestedByUserID                    FROM Subscriptions                    WHERE FacultyID = @facultyId                      AND (Status = 'Approved' OR Status IS NULL)                      AND StartDate IS NOT NULL                      AND EndDate IS NOT NULL                      AND NOW() BETWEEN StartDate AND EndDate                    ORDER BY EndDate DESC                """, new NpgsqlParameter("@facultyId", facultyId.Value))                .AsNoTracking()                .FirstOrDefaultAsync();        }        catch (Exception ex)        {            _logger.LogWarning(ex, "Index fallback query for subscription.");            activeSubscription = await _context.Subscriptions                .FromSqlRaw("""                    SELECT                        SubscriptionID, FacultyID, Name, StartDate, EndDate,                        CAST(NULL AS INT) AS DurationDays,                        CAST(NULL AS text) AS Status,                        CAST(NULL AS INT) AS RequestedByUserID                    FROM Subscriptions                    WHERE FacultyID = @facultyId                      AND StartDate IS NOT NULL                      AND EndDate IS NOT NULL                      AND NOW() BETWEEN StartDate AND EndDate                    ORDER BY EndDate DESC                """, new NpgsqlParameter("@facultyId", facultyId.Value))                .AsNoTracking()                .FirstOrDefaultAsync();        }        var totalStudents = 0;        var totalDownloads = 0;        var totalReads = 0;        try        {            totalStudents = await _context.Database.SqlQuery<int>($"""                SELECT COUNT(*) AS "Value"                FROM Users u                JOIN Roles r ON r.RoleID = u.RoleID                WHERE u.FacultyID = {facultyId.Value}                  AND r.RoleName = 'Student'            """).SingleAsync();            totalDownloads = await _context.Database.SqlQuery<int>($"""                SELECT COUNT(*) AS "Value"                FROM BookLogs bl                JOIN Users u ON u.UserID = bl.UserID                JOIN Roles r ON r.RoleID = u.RoleID                WHERE u.FacultyID = {facultyId.Value}                  AND r.RoleName = 'Student'                  AND bl.ActionType = 'DOWNLOAD'            """).SingleAsync();            totalReads = await _context.Database.SqlQuery<int>($"""                SELECT COUNT(*) AS "Value"                FROM BookLogs bl                JOIN Users u ON u.UserID = bl.UserID                JOIN Roles r ON r.RoleID = u.RoleID                WHERE u.FacultyID = {facultyId.Value}                  AND r.RoleName = 'Student'                  AND bl.ActionType = 'READ'            """).SingleAsync();        }        catch (Exception ex)        {            _logger.LogWarning(ex, "Index fallback stats with zeros.");        }        return Ok(new InstitutionIndexResponse        {            HasFaculty = true,            Faculty = faculty,            FacultyId = facultyId.Value,            ActiveSubscription = activeSubscription,            TotalStudents = totalStudents,            TotalDownloads = totalDownloads,            TotalReads = totalReads        });    }    [HttpGet("subscriptions")]    public async Task<ActionResult<InstitutionSubscriptionsResponse>> Subscriptions()    {        var userId = User.GetUserId();        var facultyId = await _context.Database            .SqlQuery<int?>($"""                SELECT FacultyID AS "Value"                FROM Users                WHERE UserID = {userId}            """)            .SingleAsync();        if (!facultyId.HasValue)        {            return Ok(new InstitutionSubscriptionsResponse            {                HasFaculty = false,                ErrorMessage = "У вас не назначено учебное заведение"            });        }        List<Subscription> templates;        try        {            templates = await _context.Subscriptions                .FromSqlRaw("""                    SELECT                        s.SubscriptionID, s.FacultyID, s.Name, s.StartDate, s.EndDate, s.DurationDays, s.Status, s.RequestedByUserID                    FROM Subscriptions s                    WHERE s.FacultyID IS NULL                    ORDER BY s.DurationDays                """)                .AsNoTracking()                .ToListAsync();        }        catch (Exception ex)        {            _logger.LogWarning(ex, "Subscriptions fallback templates.");            templates = await _context.Subscriptions                .FromSqlRaw("""                    SELECT                        s.SubscriptionID, s.FacultyID, s.Name, s.StartDate, s.EndDate,                        CAST(NULL AS INT) AS DurationDays,                        CAST(NULL AS text) AS Status,                        CAST(NULL AS INT) AS RequestedByUserID                    FROM Subscriptions s                    WHERE s.FacultyID IS NULL                    ORDER BY s.SubscriptionID                """)                .AsNoTracking()                .ToListAsync();        }        List<Subscription> mySubscriptions;        try        {            mySubscriptions = await _context.Subscriptions                .FromSqlRaw("""                    SELECT                        s.SubscriptionID, s.FacultyID, s.Name, s.StartDate, s.EndDate, s.DurationDays, s.Status, s.RequestedByUserID                    FROM Subscriptions s                    WHERE s.FacultyID = @facultyId                    ORDER BY                        CASE WHEN s.Status = 'Pending' THEN 1                             WHEN s.Status = 'Approved' THEN 2                             WHEN s.Status = 'Rejected' THEN 3                             ELSE 4 END,                        s.StartDate DESC                """, new NpgsqlParameter("@facultyId", facultyId.Value))                .AsNoTracking()                .ToListAsync();        }        catch (Exception ex)        {            _logger.LogWarning(ex, "Subscriptions fallback mySubscriptions.");            mySubscriptions = await _context.Subscriptions                .FromSqlRaw("""                    SELECT                        s.SubscriptionID, s.FacultyID, s.Name, s.StartDate, s.EndDate,                        CAST(NULL AS INT) AS DurationDays,                        CAST(NULL AS text) AS Status,                        CAST(NULL AS INT) AS RequestedByUserID                    FROM Subscriptions s                    WHERE s.FacultyID = @facultyId                    ORDER BY s.StartDate DESC                """, new NpgsqlParameter("@facultyId", facultyId.Value))                .AsNoTracking()                .ToListAsync();        }        var faculty = await _context.Faculty            .FromSqlRaw("SELECT facultyid AS \"FacultyID\", facultyname AS \"FacultyName\" FROM faculty WHERE facultyid = @id", new NpgsqlParameter("@id", facultyId.Value))            .AsNoTracking()            .FirstOrDefaultAsync();        return Ok(new InstitutionSubscriptionsResponse        {            HasFaculty = true,            Faculty = faculty,            Templates = templates,            MySubscriptions = mySubscriptions        });    }    [HttpPost("select-subscription")]    public async Task<ActionResult<ApiCommandResponse>> SelectSubscription([FromBody] SelectSubscriptionRequest request)    {        var userId = User.GetUserId();        var subscriptionId = request.SubscriptionId;        var facultyId = await _context.Database            .SqlQuery<int?>($"""                SELECT FacultyID AS "Value"                FROM Users                WHERE UserID = {userId}            """)            .SingleAsync();        if (!facultyId.HasValue)        {            return Ok(new ApiCommandResponse { Success = false, Message = "У вас не назначено учебное заведение" });        }        Subscription? template;        try        {            template = await _context.Subscriptions                .FromSqlRaw("""                    SELECT SubscriptionID, FacultyID, Name, StartDate, EndDate, DurationDays, Status, RequestedByUserID                    FROM Subscriptions                    WHERE SubscriptionID = @id AND FacultyID IS NULL                """, new NpgsqlParameter("@id", subscriptionId))                .AsNoTracking()                .FirstOrDefaultAsync();        }        catch (Exception ex)        {            _logger.LogWarning(ex, "SelectSubscription fallback template.");            template = await _context.Subscriptions                .FromSqlRaw("""                    SELECT SubscriptionID, FacultyID, Name, StartDate, EndDate,                        CAST(NULL AS INT) AS DurationDays,                        CAST(NULL AS text) AS Status,                        CAST(NULL AS INT) AS RequestedByUserID                    FROM Subscriptions                    WHERE SubscriptionID = @id AND FacultyID IS NULL                """, new NpgsqlParameter("@id", subscriptionId))                .AsNoTracking()                .FirstOrDefaultAsync();        }        if (template == null || !template.DurationDays.HasValue)        {            return Ok(new ApiCommandResponse { Success = false, Message = "Шаблон подписки не найден или некорректен" });        }        var existingActive = await _context.Subscriptions            .FromSqlRaw("""                SELECT * FROM Subscriptions                WHERE FacultyID = @facultyId                  AND (Status = 'Approved' OR Status IS NULL)                  AND NOW() BETWEEN StartDate AND EndDate            """, new NpgsqlParameter("@facultyId", facultyId.Value))            .AsNoTracking()            .FirstOrDefaultAsync();        if (existingActive != null)        {            return Ok(new ApiCommandResponse            {                Success = false,                Message = $"У вашего учебного заведения уже есть активная подписка \"{existingActive.Name}\" (до {existingActive.EndDate:dd.MM.yyyy}). Вы можете оформить новую подписку только после окончания текущей."            });        }        var existingPending = await _context.Subscriptions            .FromSqlRaw("""                SELECT * FROM Subscriptions                WHERE FacultyID = @facultyId                  AND Status = 'Pending'            """, new NpgsqlParameter("@facultyId", facultyId.Value))            .AsNoTracking()            .FirstOrDefaultAsync();        if (existingPending != null)        {            return Ok(new ApiCommandResponse            {                Success = false,                Message = $"У вас уже есть заявка на подписку \"{existingPending.Name}\", ожидающая одобрения библиотекарем. Дождитесь рассмотрения заявки."            });        }        var templatesCount = await _context.Database            .SqlQuery<int>($"SELECT COUNT(*) AS \"Value\" FROM subscriptions WHERE facultyid IS NULL")            .SingleAsync();        if (templatesCount > 3)        {            var availableTemplates = await _context.Subscriptions                .FromSqlRaw("SELECT subscriptionid AS \"SubscriptionID\", facultyid AS \"FacultyID\", name AS \"Name\", startdate AS \"StartDate\", enddate AS \"EndDate\", durationdays AS \"DurationDays\", status AS \"Status\", requestedbyuserid AS \"RequestedByUserID\" FROM subscriptions WHERE facultyid IS NULL ORDER BY subscriptionid")                .AsNoTracking()                .Select(s => s.SubscriptionID)                .ToListAsync();            if (!availableTemplates.Contains(subscriptionId))            {                return Ok(new ApiCommandResponse                {                    Success = false,                    Message = "Вы можете выбрать подписку только из трех доступных вариантов."                });            }        }        try        {            await _context.Database.ExecuteSqlRawAsync("""                INSERT INTO subscriptions (facultyid, name, startdate, enddate, durationdays, status, requestedbyuserid)                VALUES (@facultyId, @name, NULL, NULL, @durationDays, 'Pending', @requestedByUserId)            """,                new NpgsqlParameter("@facultyId", facultyId.Value),                new NpgsqlParameter("@name", template.Name),                new NpgsqlParameter("@durationDays", template.DurationDays.Value),                new NpgsqlParameter("@requestedByUserId", userId));        }        catch (Exception ex)        {            _logger.LogWarning(ex, "SelectSubscription fallback insert.");            var days = template.DurationDays.Value;            await _context.Database.ExecuteSqlRawAsync("""                INSERT INTO subscriptions (facultyid, name, startdate, enddate)                VALUES (@facultyId, @name, NOW(), NOW() + (@durationDays || ' days')::interval)            """,                new NpgsqlParameter("@facultyId", facultyId.Value),                new NpgsqlParameter("@name", template.Name),                new NpgsqlParameter("@durationDays", days));            return Ok(new ApiCommandResponse            {                Success = true,                Message = $"Подписка \"{template.Name}\" активирована сразу (старый формат базы данных)."            });        }        return Ok(new ApiCommandResponse        {            Success = true,            Message = $"Заявка на подписку \"{template.Name}\" успешно отправлена библиотекарю на рассмотрение. После одобрения подписка будет активирована для вашего учебного заведения."        });    }    [HttpGet("student-statistics")]    public async Task<ActionResult<InstitutionStudentStatsResponse>> StudentStatistics(        [FromQuery] string? search,        [FromQuery] string? sortBy,        [FromQuery] string? sortDir)    {        var userId = User.GetUserId();        var facultyId = await _context.Database            .SqlQuery<int?>($"""                SELECT FacultyID AS "Value"                FROM Users                WHERE UserID = {userId}            """)            .SingleAsync();        if (!facultyId.HasValue)        {            return Ok(new InstitutionStudentStatsResponse            {                HasFaculty = false,                ErrorMessage = "У вас не назначено учебное заведение"            });        }        var normalizedSortBy = (sortBy ?? "downloads").Trim().ToLowerInvariant();        var normalizedSortDir = (sortDir ?? "desc").Trim().ToLowerInvariant() == "asc" ? "ASC" : "DESC";        var orderColumn = normalizedSortBy switch        {            "reads" => "TotalReads",            "books" => "TotalBooksRead",            "last" => "LastActivityDate",            "name" => "LastName",            "user" => "Username",            _ => "TotalDownloads"        };        var orderClause = $"{orderColumn} {normalizedSortDir}";        var trimmedSearch = string.IsNullOrWhiteSpace(search) ? null : search.Trim();        List<StudentStatsDto> students;        try        {            var searchCondition = string.IsNullOrEmpty(trimmedSearch)                ? "1=1"                : $"u.Username ILIKE '%' || {trimmedSearch} || '%' OR u.FirstName ILIKE '%' || {trimmedSearch} || '%' OR convert_from(u.LastName, 'UTF8') ILIKE '%' || {trimmedSearch} || '%'";            students = await _context.Database.SqlQuery<StudentStatsDto>($"""                SELECT                    u.UserID,                    COALESCE(u.Username, '') AS Username,                    COALESCE(u.FirstName, '') AS FirstName,                    COALESCE(convert_from(u.LastName, 'UTF8'), '') AS LastName,                    (SELECT COUNT(*) FROM BookLogs bl WHERE bl.UserID = u.UserID AND bl.ActionType = 'DOWNLOAD') AS TotalDownloads,                    (SELECT COUNT(*) FROM BookLogs bl WHERE bl.UserID = u.UserID AND bl.ActionType = 'READ') AS TotalReads,                    (SELECT COUNT(DISTINCT bookid) FROM booklogs bl WHERE bl.userid = u.userid AND bl.actiontype = 'READ') AS TotalBooksRead,                    (SELECT MAX(actionat) FROM booklogs bl WHERE bl.userid = u.userid) AS LastActivityDate                FROM Users u                JOIN Roles r ON r.RoleID = u.RoleID                WHERE u.FacultyID = {facultyId.Value}                  AND r.RoleName = 'Student'                  AND ({searchCondition})                ORDER BY {orderClause};            """).ToListAsync();        }        catch (Exception ex)        {            _logger.LogWarning(ex, "StudentStatistics fallback no decrypt.");            var searchCondition = string.IsNullOrEmpty(trimmedSearch)                ? "1=1"                : $"u.Username ILIKE '%' || {trimmedSearch} || '%' OR u.FirstName ILIKE '%' || {trimmedSearch} || '%'";            students = await _context.Database.SqlQuery<StudentStatsDto>($"""                SELECT                    u.UserID,                    COALESCE(u.Username, '') AS Username,                    COALESCE(u.FirstName, '') AS FirstName,                    CAST('' AS text) AS LastName,                    (SELECT COUNT(*) FROM BookLogs bl WHERE bl.UserID = u.UserID AND bl.ActionType = 'DOWNLOAD') AS TotalDownloads,                    (SELECT COUNT(*) FROM BookLogs bl WHERE bl.UserID = u.UserID AND bl.ActionType = 'READ') AS TotalReads,                    (SELECT COUNT(DISTINCT bookid) FROM booklogs bl WHERE bl.userid = u.userid AND bl.actiontype = 'READ') AS TotalBooksRead,                    (SELECT MAX(actionat) FROM booklogs bl WHERE bl.userid = u.userid) AS LastActivityDate                FROM Users u                JOIN Roles r ON r.RoleID = u.RoleID                WHERE u.FacultyID = {facultyId.Value}                  AND r.RoleName = 'Student'                  AND ({searchCondition})                ORDER BY {orderClause};            """).ToListAsync();        }        var faculty = await _context.Faculty            .FromSqlRaw("SELECT facultyid AS \"FacultyID\", facultyname AS \"FacultyName\" FROM faculty WHERE facultyid = @id", new NpgsqlParameter("@id", facultyId.Value))            .AsNoTracking()            .FirstOrDefaultAsync();        return Ok(new InstitutionStudentStatsResponse        {            HasFaculty = true,            Faculty = faculty,            Search = trimmedSearch,            SortBy = normalizedSortBy,            SortDir = normalizedSortDir.ToLowerInvariant(),            Students = students        });    }    [HttpGet("book-statistics")]    public async Task<ActionResult<InstitutionBookStatsResponse>> BookStatistics(        [FromQuery] string? search,        [FromQuery] string? sortBy,        [FromQuery] string? sortDir)    {        var userId = User.GetUserId();        var facultyId = await _context.Database            .SqlQuery<int?>($"""                SELECT FacultyID AS "Value"                FROM Users                WHERE UserID = {userId}            """)            .SingleAsync();        if (!facultyId.HasValue)        {            return Ok(new InstitutionBookStatsResponse            {                HasFaculty = false,                ErrorMessage = "У вас не назначено учебное заведение"            });        }        var normalizedSortBy = (sortBy ?? "downloads").Trim().ToLowerInvariant();        var normalizedSortDir = (sortDir ?? "desc").Trim().ToLowerInvariant() == "asc" ? "ASC" : "DESC";        var orderColumn = normalizedSortBy switch        {            "reads" => "TotalReads",            "unique" => "UniqueDownloaders",            "title" => "Title",            _ => "TotalDownloads"        };        var orderClause = $"{orderColumn} {normalizedSortDir}";        var trimmedSearch = string.IsNullOrWhiteSpace(search) ? null : search.Trim();        var searchCondition = string.IsNullOrEmpty(trimmedSearch) ? "1=1" : $"b.Title ILIKE '%' || {trimmedSearch} || '%'";        var bookStats = await _context.Database            .SqlQuery<BookStatisticsDto>($"""                SELECT                    b.BookID,                    b.Title,                    (SELECT COUNT(*) FROM BookLogs bl                     JOIN Users u ON u.UserID = bl.UserID                     WHERE bl.BookID = b.BookID                       AND u.FacultyID = {facultyId.Value}                       AND bl.ActionType = 'DOWNLOAD') AS TotalDownloads,                    (SELECT COUNT(*) FROM BookLogs bl                     JOIN Users u ON u.UserID = bl.UserID                     WHERE bl.BookID = b.BookID                       AND u.FacultyID = {facultyId.Value}                       AND bl.ActionType = 'READ') AS TotalReads,                    (SELECT COUNT(DISTINCT u.UserID) FROM BookLogs bl                     JOIN Users u ON u.UserID = bl.UserID                     WHERE bl.BookID = b.BookID                       AND u.FacultyID = {facultyId.Value}                       AND bl.ActionType = 'DOWNLOAD') AS UniqueDownloaders                FROM books b                WHERE EXISTS (                    SELECT 1 FROM BookLogs bl                    JOIN Users u ON u.UserID = bl.UserID                    WHERE bl.BookID = b.BookID                      AND u.FacultyID = {facultyId.Value}                )                  AND ({searchCondition})                ORDER BY {orderClause}            """)            .ToListAsync();        var faculty = await _context.Faculty            .FromSqlRaw("SELECT facultyid AS \"FacultyID\", facultyname AS \"FacultyName\" FROM faculty WHERE facultyid = @id", new NpgsqlParameter("@id", facultyId.Value))            .AsNoTracking()            .FirstOrDefaultAsync();        return Ok(new InstitutionBookStatsResponse        {            HasFaculty = true,            Faculty = faculty,            Search = trimmedSearch,            SortBy = normalizedSortBy,            SortDir = normalizedSortDir.ToLowerInvariant(),            BookStats = bookStats        });    }}